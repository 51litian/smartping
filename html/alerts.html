<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>SmartPing Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<link href="assets/css/bootstrap.min.css" rel="stylesheet">
<link href="assets/css/bootstrap-responsive.min.css" rel="stylesheet">
<link href="assets/css/font-awesome.css" rel="stylesheet">
<link href="assets/css/style.css" rel="stylesheet">
<link href="assets/css/pages/dashboard.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="assets/datatable/css/jquery.dataTables.min.css">
<!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
<!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>
<body>
<div class="navbar navbar-fixed-top">
  <div class="navbar-inner">
    <div class="container">
      <span id="cloudbrand" class="brand" style="margin-right: -15px;"></span><a class="brand" href="index.html">SmartPing Dashbord<span id="agentname"></span></a>
      <!--/.nav-collapse -->
    </div>
    <!-- /container -->
  </div>
  <!-- /navbar-inner -->
</div>
<!-- /navbar -->
<div class="subnavbar">
  <div class="subnavbar-inner">
    <div class="container">
      <ul class="mainnav">
        <li><a href="index.html"><i class="icon-mail-forward"></i><span>正向Ping</span> </a> </li>
        <li><a href="reverse.html"><i class="icon-mail-reply"></i><span>反向Ping</span> </a> </li>
        <li><a href="topology.html"><i class="icon-bar-chart"></i><span>Ping拓扑</span> </a> </li>
        <li><a href="mapping.html"><i class="icon-map-marker"></i><span>全国延迟</span> </a> </li>
        <li  class="active"><a href="alerts.html"><i class="icon-warning-sign"></i><span>报警日志</span> </a> </li>
        <li><a href="tools.html"><i class="icon-wrench"></i><span>检测工具</span> </a> </li>
        <li><a href="config.html"><i class="icon-cog"></i><span>系统配置</span> </a> </li>
      </ul>
    </div>
    <!-- /container --> 
  </div>
  <!-- /subnavbar-inner --> 
</div>
<!-- /subnavbar -->
<div class="main" style="margin-top:-20px;">
  <div class="main-inner">
    <div class="container" id="main">
      <div class="row">

        <div class="span2"  >
          <div class="widget widget-table action-table">
            <div class="widget-header"> <i class="icon-th-list"></i>
              <h3>报警存档</h3>
            </div>
            <!-- /widget-header -->
            <div class="widget-content">
              <table class="table table-striped table-bordered">
                <thead>
                <tr>
                  <th> 日期 </th>
                </tr>
                </thead>
                <tbody class="datelist"></tbody>
              </table>
            </div>
            <!-- /widget-content -->
          </div>

        </div>

        <div class="span8">
          <div class="widget widget-table action-table">
            <div class="widget-header"> <i class="icon-th-list"></i>
              <h3>报警历史</h3>
            </div>
            <!-- /widget-header -->
            <div class="widget-content">
              <table class="table table-striped table-bordered" id="mytable">
                <thead>
                <tr>
                  <th> 报警日期 </th>
                  <th> 源节点 </th>
                  <th> 目标节点 </th>
                  <th> 工具 </th>
                </tr>
                </thead>
                <tbody class="alertlist"></tbody>
              </table>
            </div>
            <!-- /widget-content -->
          </div>
        </div>

        <div class="span2">
          <div class="widget widget-table action-table">
            <div class="widget-header"> <i class="icon-th-list"></i>
              <h3>节点列表</h3>
            </div>
            <!-- /widget-header -->
            <div class="widget-content">
              <table class="table table-striped table-bordered">
                <tbody class="agentlist">

                </tbody>
              </table>
            </div>
            <!-- /widget-content -->
          </div>
        </div>

      </div>


    </div>
    <!-- /container --> 
  </div>
  <!-- /main-inner --> 
</div>
<!-- /main -->

<div id="alert" class="modal fade" tabindex="-1" style="width: 450px;height:500px;background-color: #0c0c0c;color: white">
  <div class="modal-dialog">
       <div class="modal-content" >
         <pre style="background-color: #0c0c0c;color: white" class="tracertdata"></pre>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="footer">
  <div class="footer-inner">
    <div class="container">
      <div class="row">
        <div class="span12"> &copy; 2017 <a target="_blank" href="http://smartping.org" >SmartPing.org</a> <span style="float:right" id="verion"></span></div>
        <!-- /span12 --> 
      </div>
      <!-- /row --> 
    </div>
    <!-- /container --> 
  </div>
  <!-- /footer-inner --> 
</div>
<!-- /footer --> 
<!-- Le javascript
================================================== --> 
<!-- Placed at the end of the document so the pages load faster -->
<script src="assets/js/jquery-1.7.2.min.js"></script>
<script src="assets/js/bootstrap.js"></script>
<script src="assets/datatable/js/jquery.dataTables.min.js"></script>
<script src="assets/js/funcs.js"></script>
<script>
    var ajaxcnt  = 0;
    function getdata(d){
        $.getJSON("/api/config.json",function(result){
            $("#agentname").html(" ("+result["Name"]+")")
            AgentMode(result["Mode"],result["Status"])
            $(".datelist").html("");
            var nowtime = Date.parse(new Date())/1000
            var starttime = nowtime-result["Archive"]*86400
            for ( nowtime;nowtime>starttime;nowtime=nowtime-86400) {
                var date = new Date(nowtime*1000);
                var Y = date.getFullYear() + '';
                var M = (date.getMonth()+1 < 10 ? '0'+(date.getMonth()+1) : date.getMonth()+1) + '';
                var D = (date.getDate() < 10 ? '0' + (date.getDate()) : date.getDate()) + '';
                dstr = "alertlog-"+Y+M+D
                $(".datelist").append("<tr><td><a onclick=getdata(\"" + dstr + "\")>" + dstr + "</a></td></tr>");
            }
            $(".agentlist").html("")
            $.each(result["Targets"], function(i, field){
                if(field.Agent==true) {
                    ajaxcnt = ajaxcnt+1
                    //if(field.Addr==result["Ip"]){
                    //    return true;
                    //}
                    $(".agentlist").append("<tr><td><i class='icon-spinner icon-spin animated alerticon-" + field.Name + "' data-toggle='tooltip' title='' data-placement='bottom'></i>&nbsp;" + field.Name + "</td></tr>");

                }
            });
            $(".alertlist").html("");
            $.each(result["Targets"], function(i, field){
                if(field.Agent==true){
                    if (d==""){
                        rurl = '/api/proxy.json?g=http://' +field.Addr+':'+result['Port']+'/api/alert.json'
                    }else{
                        rurl = '/api/proxy.json?g=http://' +field.Addr+':'+result['Port']+'/api/alert.json?date='+d
                    }
                    $.ajax({
                        dataType: "json",
                        url: rurl,
                        success: function( result) {
                            ajaxcnt = ajaxcnt -1;
                            $(".alerticon-"+field.Name+"").remove();
                            for(var dal in result[1]){
                                $(".alertlist").append("<tr><td>"+result[1][dal]['Logtime']+"</td><td>"+result[1][dal]['Fromname']+"</td><td>"+result[1][dal]['Toname']+"</td><td><a onclick=\"gettracertdata(this)\" value='"+result[1][dal]['Tracert']+"'>Tracert</a></td></tr>");
                            };
                            $(".alerticon-"+field.Name+"").removeClass("icon-spinner");
                            //console.log(ajaxcnt)
                            if(ajaxcnt==0 && $(".alertlist").html()!=""){
                                pageFinish();
                            }
                        },
                        timeout: result["Timeout"]*1000
                    }).fail( function( xhr, status ) {
                        ajaxcnt = ajaxcnt -1;
                        $(".alerticon-"+field.Name+"").removeClass("icon-spinner").removeClass("icon-spin").removeClass("animated");
                        $(".alerticon-"+field.Name+"").addClass("icon-warning-sign");
                        $(".alerticon-" + field.Name + "").attr("title",xhr.responseText);
                        $(".alerticon-" + field.Name + "").tooltip();
                        if(ajaxcnt==0 && $(".alertlist").html()!=""){
                            pageFinish();
                        }
                    });
                }
            });
        });
    }
    function gettracertdata(d){
        $(".tracertdata").html($(d).attr("value"))
        $("#alert").modal('show');
    }
    function pageFinish(){
        $('#mytable').DataTable({
            "paging": false,
            "aaSorting": [[ 0, "desc" ]]
        });
    }
    $(function(){
        getdata("")
    });
</script>
</body>
</html>
